{"version":3,"sources":["mitm_popup.js"],"names":["E","assign","Object","be_ui_popup_ext","be_popup_main","be_vpn","be_info","be_ext","B","assert_popup","get_url","zutil","get","window","get_tab_id","get_root_url","svc_util","skip_watermark","root_url","be_util","is_google","is_youtube","perr","id","info","url","be_popup_lib","perr_ok","WATERMARK","SUGGESTION","SUBSCRIBE","Mitm_suggestion","props","close_click","ignore","no_click","yes_click","fcall","close_cb","width","height","size_cb","center","fade","close_tpopup","React","Component","Mitm_popup","on_body_click","state","mode","is_plus","opt","on_close","set_mode","_this","on_manual_unblock","ecall","enabled","on","off","prev_props","prev_state","position","position_cb","show_vpn_ui_cb","watermark","Popup_base","inited","init","ui_popup","render","default_pos","css","maxWidth","maxHeight","animation","el","appendTo","unmount","ReactDOM","unmountComponentAtNode","remove","on_show_vpn_ui","attr","set_tpopup_type"],"mappings":"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","file":"mitm_popup.js","sourcesContent":["                   \n'use strict';                                              \nimport 'regenerator-runtime';\nimport $ from 'jquery';\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport B from '/bext/pub/browser.js';\nimport zutil from '/util/util.js';\nimport etask from '/util/etask.js';\nimport svc_util from '/svc/vpn/pub/util.js';\nimport be_util from '/bext/pub/util.js';\nimport watermark from '/bext/vpn/pub/watermark.js';\nimport be_popup_lib from '/bext/pub/popup_lib.js';\nconst E = {};\nconst assign = Object.assign;\nlet be_ui_popup_ext, be_popup_main, be_vpn, be_info, be_ext;\n\nB.assert_popup('be_mitm_popup');\n\nconst get_url = ()=>zutil.get(window, 'hola.tpopup_opt.url');\nconst get_tab_id = ()=>zutil.get(window, 'hola.tpopup_opt.tab_id');\nconst get_root_url = ()=>svc_util.get_root_url(get_url());\n\nfunction skip_watermark(){\n    let root_url = get_root_url();\n    return be_util.is_google(root_url) || be_util.is_youtube(root_url);\n}\n\nconst perr = (id, info)=>{\n    info = assign({url: get_url()}, info);\n    be_popup_lib.perr_ok({id, info}, true);\n};\n\nconst WATERMARK = 'watermark', SUGGESTION = 'suggestion';\nconst SUBSCRIBE = 'subscribe';\nclass Mitm_suggestion extends React.Component {\n    constructor(props){\n        super(props);\n        let width = 550, height = 370;\n        this.props.size_cb({width: width+8, height: height+8, center: true,\n            fade: true}, {width, height});\n    }\n    ignore(){\n        be_vpn.fcall('mitm_set_ignore', [get_url(), get_tab_id()]);\n        this.props.close_cb({close_tpopup: true});\n    }\n    close_click = ()=>{\n        perr('mitm_popup_suggestion_close');\n        this.ignore();\n    };\n    no_click = ()=>{\n        perr('mitm_popup_suggestion_no');\n        this.ignore();\n    };\n    yes_click = ()=>{\n        perr('mitm_popup_suggestion_yes');\n        be_vpn.fcall('mitm_set_unblock', [get_url()]);\n        this.props.close_cb();\n    };\n    render(){\n        return (\n            <watermark.Wrap>\n              <watermark.Modal_header close_click={this.close_click}/>\n              <watermark.Suggestion_body is_mitm={true}\n                yes_click={this.yes_click}\n                no_click={this.no_click}/>\n            </watermark.Wrap>\n        );\n    }\n}\n\nclass Mitm_popup extends watermark.Popup_base {\n    componentDidMount(){\n        super.componentDidMount();\n        let _this = this;\n        this.on_manual_unblock = ()=>etask(function*(){\n            let enabled = yield be_vpn.ecall('is_mitm_active_manual',\n                [get_tab_id()]);\n            if (_this.state.mode==SUGGESTION && enabled)\n                _this.close_cb();\n        });\n        be_vpn.on('mitm_manual_unblock', this.on_manual_unblock);\n        be_ui_popup_ext.on('body_click', this.on_body_click);\n    }\n    componentWillUnmount(){\n        super.componentWillUnmount();\n        be_vpn.off('mitm_manual_unblock', this.on_manual_unblock);\n        be_ui_popup_ext.off('body_click', this.on_body_click);\n    }\n    componentDidUpdate(prev_props, prev_state){\n        super.componentDidUpdate(prev_props, prev_state);\n        if (this.state.is_plus && this.state.mode==SUBSCRIBE)\n            this.props.on_close();\n    }\n    on_body_click = ()=>{\n        if (this.state.mode==SUBSCRIBE)\n            this.close_cb();\n    };\n    close_cb = opt=>{\n        if (this.state.is_plus || skip_watermark() || opt&&opt.close_tpopup)\n            return void this.props.on_close();\n        let {mode} = this.state;\n        if (mode==SUGGESTION || mode==SUBSCRIBE)\n            this.set_mode(WATERMARK);\n        else if (mode==WATERMARK)\n            this.set_mode(SUBSCRIBE);\n    };\n    render_inner(){\n        let {state} = this;\n        return state.mode==WATERMARK ?\n            <watermark.Watermark is_mitm={true}\n              position={state.position}\n              position_cb={this.position_cb}\n              close_cb={this.close_cb}\n              show_vpn_ui_cb={this.show_vpn_ui_cb}\n              size_cb={this.size_cb}/> :\n            state.mode==SUBSCRIBE ?\n            <watermark.Subscribe close_cb={this.close_cb}\n              is_mitm={true} size_cb={this.size_cb}/> :\n            <Mitm_suggestion close_cb={this.close_cb}\n              size_cb={this.size_cb}/>;\n    }\n}\n\nlet inited;\nE.init = ui_popup=>{\n    if (inited)\n        return;\n    inited = true;\n    be_ui_popup_ext = ui_popup;\n    be_popup_main = ui_popup.be_popup_main;\n    be_vpn = ui_popup.be_vpn;\n    be_info = ui_popup.be_info;\n    be_ext = ui_popup.be_ext;\n    watermark.init(ui_popup);\n};\n\nE.render = ()=>etask(function*(){\n    let enabled = yield be_vpn.ecall('is_mitm_active_manual', [get_tab_id()]);\n    if (enabled && skip_watermark())\n    {\n                              \n        perr('mitm_watermark_skip');\n        return;\n    }\n    let default_pos = zutil.get(be_ext.get('bext_config'),\n        'geo_popup.watermark.position', 'top_right');\n    let position = yield be_info.ecall('get_site_storage', [get_root_url(),\n        'watermark_pos', default_pos]);\n    $('html').css({width: '100%', height: '100%', maxWidth: '100%',\n        maxHeight: '100%'});\n    $('body').css({animation: 'none'});\n    let el = $('<div class=mitm-popup-root/>').appendTo($('body'));\n    const unmount = ()=>{\n        ReactDOM.unmountComponentAtNode(el[0]);\n        el.remove();\n    };\n    let on_close = ()=>{\n        unmount();\n        be_popup_main.close_tpopup();\n    };\n    const on_show_vpn_ui = ()=>{\n        unmount();\n        $('#all').attr('style', '');\n        $('#all').attr('class', '');\n        be_ui_popup_ext.set_tpopup_type(null);\n    };\n    ReactDOM.render(<Mitm_popup\n        on_close={on_close}\n        on_show_vpn_ui={on_show_vpn_ui}\n        position={position}\n        mode={enabled ? WATERMARK : SUGGESTION}/>, el[0]);\n});\n\nexport default E;\n"]}